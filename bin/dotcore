#!/usr/bin/env bash

set -e

_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
PATH=${_DIR}:${PATH}

$(shim) && cd ${DOTCORE_DIR} && . bin/i.sh

command_apply() {
  log:: "applying dotfiles"
  dotcore-pull
  dotcore-apps
  dotcore-stow
  dotcore-projects
  dotcore-fish
  dotcore-fisher
}

while getopts "e:i:F" opt; do
  case "$opt" in
  e)
    EXCLUDES=$OPTARG
    ;;
  i)
    INCLUDES=$OPTARG
    ;;
  F)
    FORCE_ALL=1
    ;;
  esac
done

shift $((OPTIND - 1))
[ "${1:-}" == "--" ] && shift

if [[ -n "$FORCE_ALL" ]]; then
  for f in ${DOTCORE_DIR}/bin/dotcore-*; do
    should-run -c ${f##*/}
  done
fi

if [[ -n "$EXCLUDES" ]] || [[ -n "$INCLUDES" ]]; then
  if [[ -n "$EXCLUDES" ]]; then
    should-run -e "$EXCLUDES"
  else
    should-run -i "$INCLUDES"
  fi
  exit 0
fi

COMMAND=${1:-apply}
command_${COMMAND} $@
if [ $? = 127 ]; then
  echo "'$COMMAND_NAME' is not a known command or has errors." >&2
  usage
  exit 1
fi
